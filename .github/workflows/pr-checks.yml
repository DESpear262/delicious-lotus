name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
    paths:
      - 'fastapi/**'
      - '.github/workflows/pr-checks.yml'

env:
  PYTHON_VERSION: '3.13'

jobs:
  # Job 1: Code quality checks (black, flake8, mypy)
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./fastapi
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 mypy

      - name: Run Black (code formatting check)
        working-directory: ./fastapi
        run: |
          echo "### Code Formatting Check (Black)" >> $GITHUB_STEP_SUMMARY
          if black --check app/ tests/; then
            echo "✅ Code formatting is correct" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Code formatting issues found. Run 'black app/ tests/' to fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run Flake8 (linting)
        working-directory: ./fastapi
        run: |
          echo "### Linting Check (Flake8)" >> $GITHUB_STEP_SUMMARY
          if flake8 app/ tests/ --max-line-length=100 --extend-ignore=E203,W503 --count --statistics; then
            echo "✅ No linting issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Linting issues found. Please fix the issues above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Run MyPy (type checking)
        working-directory: ./fastapi
        run: |
          echo "### Type Checking (MyPy)" >> $GITHUB_STEP_SUMMARY
          if mypy app/ --ignore-missing-imports --no-error-summary; then
            echo "✅ Type checking passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Type checking completed with warnings" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Run tests with coverage
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./fastapi
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run pytest with coverage
        working-directory: ./fastapi
        run: |
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html \
            --junitxml=test-results.xml \
            --verbose

      - name: Check coverage threshold
        working-directory: ./fastapi
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(float(root.attrib['line-rate']) * 100)")
          THRESHOLD=80

          echo "### Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** ${THRESHOLD}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "❌ Coverage (${COVERAGE}%) is below threshold (${THRESHOLD}%)" >> $GITHUB_STEP_SUMMARY
            echo "Coverage check failed: ${COVERAGE}% < ${THRESHOLD}%"
            exit 1
          else
            echo "✅ Coverage (${COVERAGE}%) meets threshold (${THRESHOLD}%)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            fastapi/coverage.xml
            fastapi/htmlcov/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: fastapi/test-results.xml
          retention-days: 30

      - name: Comment PR with coverage
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const xml2js = require('xml2js');

            try {
              const xmlData = fs.readFileSync('fastapi/coverage.xml', 'utf8');
              const parser = new xml2js.Parser();

              parser.parseString(xmlData, (err, result) => {
                if (err) {
                  console.log('Error parsing coverage XML');
                  return;
                }

                const coverage = (parseFloat(result.coverage.$.['line-rate']) * 100).toFixed(2);
                const message = `## Test Coverage Report\n\n**Coverage:** ${coverage}%\n**Threshold:** 80%\n\n${coverage >= 80 ? '✅ Coverage meets threshold' : '❌ Coverage below threshold'}`;

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: message
                });
              });
            } catch (error) {
              console.log('Could not read coverage file:', error);
            }

  # Job 3: Build validation
  build-validation:
    name: Validate Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./fastapi
          file: ./fastapi/Dockerfile
          push: false
          load: true
          tags: ai-video-backend:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Check image size
        id: image-size
        run: |
          IMAGE_SIZE=$(docker images ai-video-backend:pr-${{ github.event.pull_request.number }} --format "{{.Size}}")
          IMAGE_SIZE_MB=$(docker images ai-video-backend:pr-${{ github.event.pull_request.number }} --format "{{.Size}}" | sed 's/MB//' | sed 's/GB/*1024/' | bc 2>/dev/null || echo "0")

          echo "Image size: $IMAGE_SIZE"
          echo "image-size=$IMAGE_SIZE" >> $GITHUB_OUTPUT

          # Check if image is larger than 500MB
          if [ ! -z "$IMAGE_SIZE_MB" ] && (( $(echo "$IMAGE_SIZE_MB > 500" | bc -l 2>/dev/null || echo "0") )); then
            echo "### ⚠️ Docker Image Size Warning" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Image Size:** $IMAGE_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended:** < 500MB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consider optimizing the Docker image to reduce size." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ✅ Docker Image Size" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Image Size:** $IMAGE_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** Within recommended limits" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test image runs
        run: |
          # Start container in detached mode
          docker run -d --name test-backend \
            -p 8000:8000 \
            -e APP_ENV=test \
            ai-video-backend:pr-${{ github.event.pull_request.number }}

          # Wait for container to start
          sleep 10

          # Check if container is running
          if ! docker ps | grep -q test-backend; then
            echo "Container failed to start"
            docker logs test-backend
            exit 1
          fi

          # Test health endpoint
          if ! curl -f http://localhost:8000/health; then
            echo "Health check failed"
            docker logs test-backend
            exit 1
          fi

          # Cleanup
          docker stop test-backend
          docker rm test-backend

          echo "### ✅ Docker Container Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Container started successfully and health check passed." >> $GITHUB_STEP_SUMMARY

  # Job 4: Summary status check
  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test, build-validation]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "### Pull Request Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "✅ Code Quality Checks: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Code Quality Checks: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Tests & Coverage: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests & Coverage: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build-validation.result }}" == "success" ]; then
            echo "✅ Build Validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build Validation: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail if any job failed
          if [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build-validation.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** ❌ Some checks failed. Please review and fix the issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** ✅ All checks passed! Ready to merge." >> $GITHUB_STEP_SUMMARY
          fi
