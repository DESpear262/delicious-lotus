name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  # Validate PR title follows conventional commits
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          scopes: |
            api
            worker
            db
            s3
            redis
            ffmpeg
            tests
            ci
            deps
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  # Check PR size
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let additions = 0;
            let deletions = 0;
            let changedFiles = files.length;

            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });

            const totalChanges = additions + deletions;

            let label = 'size/S';
            let color = '00FF00';
            let message = 'This PR has a small number of changes.';

            if (totalChanges > 1000) {
              label = 'size/XXL';
              color = 'FF0000';
              message = '⚠️ This PR is very large. Consider breaking it into smaller PRs for easier review.';
            } else if (totalChanges > 500) {
              label = 'size/XL';
              color = 'FF6600';
              message = '⚠️ This PR is large. Consider breaking it into smaller PRs.';
            } else if (totalChanges > 250) {
              label = 'size/L';
              color = 'FFAA00';
              message = 'This PR is moderately large.';
            } else if (totalChanges > 100) {
              label = 'size/M';
              color = 'FFFF00';
              message = 'This PR has a moderate number of changes.';
            }

            // Add size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

            // Comment on large PRs
            if (totalChanges > 500) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `${message}\n\n**Changes:** ${totalChanges} lines (+${additions}/-${deletions}) across ${changedFiles} files`
              });
            }

  # Check for changelog update
  changelog-check:
    name: Check Changelog
    runs-on: ubuntu-latest
    if: "!contains(github.event.pull_request.labels.*.name, 'skip-changelog')"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for CHANGELOG update
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const changelogUpdated = files.some(file =>
              file.filename.toLowerCase().includes('changelog')
            );

            if (!changelogUpdated) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '⚠️ This PR does not update the CHANGELOG. If this is intentional, add the `skip-changelog` label.'
              });
            }

  # Detect TODO/FIXME comments
  todo-check:
    name: Detect TODO/FIXME
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for TODO/FIXME
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let todoCount = 0;
            let fixmeCount = 0;

            for (const file of files) {
              if (file.status === 'removed') continue;
              if (!file.filename.endsWith('.py')) continue;

              const { data: content } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: file.filename,
                ref: context.payload.pull_request.head.sha
              });

              const decoded = Buffer.from(content.content, 'base64').toString('utf-8');
              const todoMatches = decoded.match(/TODO:/gi);
              const fixmeMatches = decoded.match(/FIXME:/gi);

              if (todoMatches) todoCount += todoMatches.length;
              if (fixmeMatches) fixmeCount += fixmeMatches.length;
            }

            if (todoCount > 0 || fixmeCount > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ℹ️ This PR contains ${todoCount} TODO and ${fixmeCount} FIXME comments. Please ensure they are tracked as issues.`
              });
            }
